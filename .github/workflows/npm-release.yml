# npm packages release automation

name: npm Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'
  # TODO: Just for testing. Remove after testing.
  pull_request:
    branches:
      - main

env:
  PRODUCTION_REGISTRY_URL: https://wombat-dressing-room.appspot.com
  LOCAL_REGISTRY_URL: http://localhost:4873

jobs:
  dry-run:
    name: Dry-run release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # See go/npm-publish
      - name: Setup Node
        uses: actions/setup-node@v2.5.0
        with:
          node-version-file: '.nvmrc'
          cache: npm

      # For the time being, using incremental versions like v0.1.202111302140
      - name: Version bumps
        run: npm version --workspaces --no-git-tag-version "0.1.$(date -u +%Y%m%d%H%M)"

      # Set up a local npm registry with Verdaccio.
      - name: Set up local registry
        run: bash bin/setup-local-npm-registry.sh

      # Using Verdaccio
      - name: Publish packages locally
        run: npm --registry=$LOCAL_REGISTRY_URL --workspaces publish
        env:
          NPM_CONFIG_REGISTRY: ${{ env.LOCAL_REGISTRY_URL }}

      - name: Stop local registry
        run: bash bin/stop-local-npm-registry.sh

      # Undo the version bumps in Git. We only needed them for testing.
      - name: Clean up local changes
        run: git checkout .

  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [dry-run]
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # See go/npm-publish
      - name: Setup Node
        uses: actions/setup-node@v2.5.0
        with:
          node-version-file: '.nvmrc'
          cache: npm
          registry-url: ${{ env.PRODUCTION_REGISTRY_URL }}
          scope: '@googleforcreators'

      # For the time being, using incremental versions like v0.1.202111302140
      - name: Version bumps
        run: npm version --workspaces --no-git-tag-version "0.1.$(date -u +%Y%m%d%H%M)"

      # Dry-run releasing
      - name: Dry-run production release
        run: npm publish --workspaces --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISHING_TOKEN }}

      #      # Do the actual publishing to npmjs.com.
      #      - name: Publish packages to production
      #        run: npm publish --workspaces
      #        env:
      #          NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISHING_TOKEN }}

      # Undo the version bumps in Git. We only needed them for publishing.
      - name: Clean up local changes
        run: git checkout .
